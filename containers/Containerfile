# Stage 1: Build
FROM mcr.microsoft.com/dotnet/sdk:9.0 AS build
WORKDIR /src

# Copy solution and project files first (layer caching)
COPY Candour.sln Directory.Build.props ./
COPY src/Candour.Core/Candour.Core.csproj src/Candour.Core/
COPY src/Candour.Application/Candour.Application.csproj src/Candour.Application/
COPY src/Candour.Infrastructure/Candour.Infrastructure.csproj src/Candour.Infrastructure/
COPY src/Candour.Shared/Candour.Shared.csproj src/Candour.Shared/
COPY src/Candour.Api/Candour.Api.csproj src/Candour.Api/
COPY src/Candour.Web/Candour.Web.csproj src/Candour.Web/
RUN dotnet restore Candour.sln

# Copy source and build
COPY src/ src/
RUN dotnet publish src/Candour.Api/Candour.Api.csproj -c Release -o /app/api --no-restore
RUN dotnet publish src/Candour.Web/Candour.Web.csproj -c Release -o /app/web --no-restore

# Stage 2: Runtime - API
FROM mcr.microsoft.com/dotnet/aspnet:9.0 AS api
WORKDIR /app
COPY --from=build /app/api .
ENV ASPNETCORE_URLS=http://+:5001
ENV ASPNETCORE_ENVIRONMENT=Production
EXPOSE 5001
ENTRYPOINT ["dotnet", "Candour.Api.dll"]

# Stage 3: Runtime - Web
FROM mcr.microsoft.com/dotnet/aspnet:9.0 AS web
WORKDIR /app
COPY --from=build /app/web .
ENV ASPNETCORE_URLS=http://+:5000
ENV ASPNETCORE_ENVIRONMENT=Production
EXPOSE 5000
ENTRYPOINT ["dotnet", "Candour.Web.dll"]
