@page "/admin/builder"
@using Candour.Application.Surveys
@using Candour.Core.Enums
@using MediatR
@rendermode InteractiveServer
@inject IMediator Mediator
@inject NavigationManager Nav

<PageTitle>Survey Builder - Candour</PageTitle>

<MudContainer MaxWidth="MaxWidth.Medium" Class="mt-8">
    <MudText Typo="Typo.h4" GutterBottom="true">Create Survey</MudText>

    <MudCard Elevation="2" Class="mb-4">
        <MudCardContent>
            <MudTextField @bind-Value="_title" Label="Survey Title" Variant="Variant.Outlined" Required="true" Class="mb-4" />
            <MudTextField @bind-Value="_description" Label="Description" Variant="Variant.Outlined" Lines="3" Class="mb-4" />

            <MudGrid>
                <MudItem xs="6">
                    <MudNumericField @bind-Value="_threshold" Label="Anonymity Threshold"
                                     Variant="Variant.Outlined" Min="1" Max="1000"
                                     HelperText="Minimum responses before results visible" />
                </MudItem>
                <MudItem xs="6">
                    <MudNumericField @bind-Value="_jitterMinutes" Label="Timestamp Jitter (minutes)"
                                     Variant="Variant.Outlined" Min="0" Max="1440"
                                     HelperText="Random offset applied to submission times" />
                </MudItem>
            </MudGrid>
        </MudCardContent>
    </MudCard>

    <MudText Typo="Typo.h5" GutterBottom="true" Class="mt-6">Questions</MudText>

    @for (int i = 0; i < _questions.Count; i++)
    {
        var idx = i;
        <MudCard Class="mb-4" Elevation="1">
            <MudCardContent>
                <MudGrid>
                    <MudItem xs="8">
                        <MudTextField @bind-Value="_questions[idx].Text" Label="@($"Question {idx + 1}")"
                                      Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="4">
                        <MudSelect @bind-Value="_questions[idx].Type" Label="Type" Variant="Variant.Outlined">
                            @foreach (var qt in Enum.GetValues<QuestionType>())
                            {
                                <MudSelectItem Value="@qt">@qt</MudSelectItem>
                            }
                        </MudSelect>
                    </MudItem>
                </MudGrid>

                @if (_questions[idx].Type == QuestionType.MultipleChoice || _questions[idx].Type == QuestionType.Matrix)
                {
                    <MudTextField @bind-Value="_questions[idx].OptionsText" Label="Options (comma-separated)"
                                  Variant="Variant.Outlined" Class="mt-2"
                                  HelperText="e.g., Option A, Option B, Option C" />
                }

                <MudGrid Class="mt-2">
                    <MudItem xs="6">
                        <MudCheckBox @bind-Value="_questions[idx].Required" Label="Required" />
                    </MudItem>
                    <MudItem xs="6" Class="d-flex justify-end">
                        <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error"
                                       OnClick="@(() => RemoveQuestion(idx))" />
                    </MudItem>
                </MudGrid>
            </MudCardContent>
        </MudCard>
    }

    <MudButton Variant="Variant.Outlined" Color="Color.Primary" OnClick="AddQuestion" Class="mb-4">
        Add Question
    </MudButton>

    @if (!string.IsNullOrEmpty(_error))
    {
        <MudAlert Severity="Severity.Error" Class="mb-4">@_error</MudAlert>
    }

    <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="CreateSurvey"
               Disabled="_creating" FullWidth="true" Size="Size.Large" Class="mt-4">
        @if (_creating)
        {
            <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
        }
        Create Survey
    </MudButton>
</MudContainer>

@code {
    private string _title = "";
    private string _description = "";
    private int _threshold = 5;
    private int _jitterMinutes = 10;
    private List<QuestionInput> _questions = new() { new() };
    private bool _creating;
    private string? _error;

    private class QuestionInput
    {
        public string Text { get; set; } = "";
        public QuestionType Type { get; set; } = QuestionType.MultipleChoice;
        public string OptionsText { get; set; } = "";
        public bool Required { get; set; } = true;
    }

    private void AddQuestion() => _questions.Add(new QuestionInput());
    private void RemoveQuestion(int idx) { if (_questions.Count > 1) _questions.RemoveAt(idx); }

    private async Task CreateSurvey()
    {
        if (string.IsNullOrWhiteSpace(_title))
        {
            _error = "Title is required.";
            return;
        }

        _creating = true;
        _error = null;

        var command = new CreateSurveyCommand(
            _title,
            _description,
            "admin",
            _threshold,
            _jitterMinutes,
            _questions.Select((q, i) => new CreateQuestionItem(
                q.Type,
                q.Text,
                q.Type is QuestionType.MultipleChoice or QuestionType.Matrix
                    ? q.OptionsText.Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries).ToList()
                    : q.Type == QuestionType.YesNo
                        ? new List<string> { "Yes", "No" }
                        : new List<string>(),
                q.Required,
                i + 1
            )).ToList()
        );

        var survey = await Mediator.Send(command);
        Nav.NavigateTo($"/admin/survey/{survey.Id}");
    }
}
