@page "/admin/survey/{SurveyId:guid}"
@using Candour.Application.Surveys
@using Candour.Application.Responses
@using MediatR
@using System.Text.Json
@rendermode InteractiveServer
@inject IMediator Mediator

<PageTitle>Survey Details - Candour</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-8">
    @if (_loading)
    {
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
    }
    else if (_survey == null)
    {
        <MudAlert Severity="Severity.Error">Survey not found.</MudAlert>
    }
    else
    {
        <MudText Typo="Typo.h4" GutterBottom="true">@_survey.Title</MudText>
        <MudText Typo="Typo.body1" Class="mb-2">@_survey.Description</MudText>
        <MudChip T="string" Color="@GetStatusColor(_survey.Status)">@_survey.Status</MudChip>
        <MudText Typo="Typo.caption" Class="mb-4 d-block">
            Anonymity Threshold: @_survey.AnonymityThreshold | Jitter: Â±@_survey.TimestampJitterMinutes min
        </MudText>

        @if (_survey.Status == Core.Enums.SurveyStatus.Draft)
        {
            <MudButton Variant="Variant.Filled" Color="Color.Success" OnClick="Publish" Class="mb-4">
                Publish Survey
            </MudButton>
        }

        @if (_publishResult != null)
        {
            <MudCard Class="mb-4" Elevation="2">
                <MudCardContent>
                    <MudText Typo="Typo.h6">Survey Published!</MudText>
                    <MudText Typo="Typo.body2" Class="mb-2">
                        Share link: <code>/survey/@_survey.Id?t=TOKEN</code>
                    </MudText>
                    <MudText Typo="Typo.body2">Generated @_publishResult.Tokens.Count tokens.</MudText>
                    <MudExpansionPanels Class="mt-2">
                        <MudExpansionPanel Text="Show Tokens">
                            <MudList T="string" Dense="true">
                                @foreach (var token in _publishResult.Tokens.Take(20))
                                {
                                    <MudListItem T="string">
                                        <MudText Typo="Typo.caption" Style="font-family: monospace;">
                                            /survey/@_survey.Id?t=@Uri.EscapeDataString(token)
                                        </MudText>
                                    </MudListItem>
                                }
                                @if (_publishResult.Tokens.Count > 20)
                                {
                                    <MudListItem T="string">
                                        <MudText Typo="Typo.caption">... and @(_publishResult.Tokens.Count - 20) more</MudText>
                                    </MudListItem>
                                }
                            </MudList>
                        </MudExpansionPanel>
                    </MudExpansionPanels>
                </MudCardContent>
            </MudCard>
        }

        <MudText Typo="Typo.h5" Class="mt-6 mb-4">Questions</MudText>
        @foreach (var q in _survey.Questions.OrderBy(q => q.Order))
        {
            <MudCard Class="mb-2" Elevation="1">
                <MudCardContent>
                    <MudText Typo="Typo.body1">
                        <strong>Q@(q.Order):</strong> @q.Text
                        <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined">@q.Type</MudChip>
                    </MudText>
                </MudCardContent>
            </MudCard>
        }

        <MudText Typo="Typo.h5" Class="mt-6 mb-4">Results</MudText>
        <MudButton Variant="Variant.Outlined" Color="Color.Primary" OnClick="LoadResults" Class="mb-4">
            Load Aggregate Results
        </MudButton>

        @if (_resultsError != null)
        {
            <MudAlert Severity="Severity.Warning">@_resultsError</MudAlert>
        }
        else if (_results != null)
        {
            <MudText Typo="Typo.body1" Class="mb-4">Total Responses: @_results.TotalResponses</MudText>

            @foreach (var qr in _results.Questions)
            {
                <MudCard Class="mb-4" Elevation="1">
                    <MudCardContent>
                        <MudText Typo="Typo.h6">@qr.QuestionText</MudText>
                        <MudText Typo="Typo.caption" Color="Color.Secondary">@qr.QuestionType</MudText>

                        @if (qr.OptionCounts.Any())
                        {
                            <MudSimpleTable Dense="true" Class="mt-2">
                                <thead>
                                    <tr><th>Option</th><th>Count</th><th>Percentage</th></tr>
                                </thead>
                                <tbody>
                                    @foreach (var (opt, count) in qr.OptionCounts)
                                    {
                                        <tr>
                                            <td>@opt</td>
                                            <td>@count</td>
                                            <td>@(qr.OptionPercentages.GetValueOrDefault(opt, 0).ToString("F1"))%</td>
                                        </tr>
                                    }
                                </tbody>
                            </MudSimpleTable>
                        }

                        @if (qr.AverageRating.HasValue)
                        {
                            <MudText Class="mt-2">Average Rating: @qr.AverageRating.Value.ToString("F1") / 5</MudText>
                        }

                        @if (qr.FreeTextAnswers.Any())
                        {
                            <MudText Typo="Typo.subtitle2" Class="mt-2">Free Text Responses (shuffled):</MudText>
                            <MudList T="string" Dense="true">
                                @foreach (var answer in qr.FreeTextAnswers)
                                {
                                    <MudListItem T="string">@answer</MudListItem>
                                }
                            </MudList>
                        }
                    </MudCardContent>
                </MudCard>
            }
        }
    }
</MudContainer>

@code {
    [Parameter] public Guid SurveyId { get; set; }

    private Core.Entities.Survey? _survey;
    private PublishSurveyResult? _publishResult;
    private Core.ValueObjects.AggregateData? _results;
    private string? _resultsError;
    private bool _loading = true;

    protected override async Task OnInitializedAsync()
    {
        _survey = await Mediator.Send(new GetSurveyQuery(SurveyId));
        _loading = false;
    }

    private Color GetStatusColor(Core.Enums.SurveyStatus status) => status switch
    {
        Core.Enums.SurveyStatus.Draft => Color.Default,
        Core.Enums.SurveyStatus.Active => Color.Success,
        Core.Enums.SurveyStatus.Closed => Color.Error,
        _ => Color.Default
    };

    private async Task Publish()
    {
        _publishResult = await Mediator.Send(new PublishSurveyCommand(SurveyId));
        _survey = await Mediator.Send(new GetSurveyQuery(SurveyId));
    }

    private async Task LoadResults()
    {
        _resultsError = null;
        var result = await Mediator.Send(new GetAggregateResultsQuery(SurveyId));

        if (result.Success)
            _results = result.Data;
        else
            _resultsError = result.Error;
    }
}
