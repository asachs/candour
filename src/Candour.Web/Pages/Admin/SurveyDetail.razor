@page "/admin/survey/{SurveyId:guid}"
@attribute [Authorize]
@inject ICandourApiClient Api
@inject NavigationManager Nav
@inject IJSRuntime JS

<PageTitle>Survey Details - Candour</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-8">
    @if (_loading)
    {
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
    }
    else if (_survey == null)
    {
        <MudAlert Severity="Severity.Error">Survey not found.</MudAlert>
    }
    else
    {
        <div @key="_renderKey">
        <MudText Typo="Typo.h4" GutterBottom="true">@_survey.Title</MudText>
        <MudText Typo="Typo.body1" Class="mb-2">@_survey.Description</MudText>
        <MudChip T="string" Color="@GetStatusColor(_survey.Status)">@_survey.Status</MudChip>
        <MudText Typo="Typo.caption" Class="mb-4 d-block">
            Anonymity Threshold: @_survey.AnonymityThreshold | Jitter: Â±@_survey.TimestampJitterMinutes min
        </MudText>

        <MudButton Variant="Variant.Filled" Color="Color.Success" OnClick="Publish" Class="mb-4"
                   Disabled="@(_survey.Status != "Draft")"
                   Style="@(_survey.Status != "Draft" ? "display:none" : "")">
            Publish Survey
        </MudButton>

        @if (_publishResult != null)
        {
            <MudCard Class="mb-4" Elevation="2">
                <MudCardContent>
                    <MudText Typo="Typo.h6">Survey Published!</MudText>
                    <MudText Typo="Typo.body2">Generated @_publishResult.Tokens.Count tokens.</MudText>
                    <div Class="d-flex gap-2 mt-2">
                        <MudButton Variant="Variant.Outlined" Size="Size.Small" OnClick="() => _showTokens = !_showTokens">
                            @(_showTokens ? "Hide Tokens" : "Show Tokens")
                        </MudButton>
                        <MudButton Variant="Variant.Outlined" Size="Size.Small" Color="Color.Primary" OnClick="CopyAllLinks">
                            Copy All Links
                        </MudButton>
                    </div>
                    @if (_showTokens)
                    {
                        <MudList T="string" Dense="true" Class="mt-2">
                            @foreach (var token in _publishResult.Tokens.Take(20))
                            {
                                var tokenLink = GetTokenLink(token);
                                <MudListItem T="string">
                                    <div class="d-flex align-center gap-2">
                                        <MudText Typo="Typo.caption" Style="font-family: monospace; word-break: break-all; flex: 1;">
                                            @tokenLink
                                        </MudText>
                                        <MudTooltip Text="Copy link">
                                            <MudIconButton Icon="@Icons.Material.Filled.ContentCopy" Size="Size.Small"
                                                           OnClick="@(() => CopyToClipboard(tokenLink))" />
                                        </MudTooltip>
                                    </div>
                                </MudListItem>
                            }
                            @if (_publishResult.Tokens.Count > 20)
                            {
                                <MudListItem T="string">
                                    <MudText Typo="Typo.caption">... and @(_publishResult.Tokens.Count - 20) more (use "Copy All Links" to get all)</MudText>
                                </MudListItem>
                            }
                        </MudList>
                    }
                </MudCardContent>
            </MudCard>
        }

        <MudText Typo="Typo.h5" Class="mt-6 mb-4">Questions</MudText>
        @foreach (var q in _survey.Questions.OrderBy(q => q.Order))
        {
            <MudCard Class="mb-2" Elevation="1">
                <MudCardContent>
                    <MudText Typo="Typo.body1">
                        <strong>Q@(q.Order):</strong> @q.Text
                        <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined">@q.Type</MudChip>
                    </MudText>
                </MudCardContent>
            </MudCard>
        }

        <MudText Typo="Typo.h5" Class="mt-6 mb-4">Results</MudText>
        <MudButton Variant="Variant.Outlined" Color="Color.Primary" OnClick="LoadResults" Class="mb-4">
            Load Aggregate Results
        </MudButton>

        @if (_resultsError != null)
        {
            <MudAlert Severity="Severity.Warning">@_resultsError</MudAlert>
        }
        else if (_results != null)
        {
            <MudText Typo="Typo.body1" Class="mb-4">Total Responses: @_results.TotalResponses</MudText>

            @foreach (var qr in _results.Questions)
            {
                <MudCard Class="mb-4" Elevation="1">
                    <MudCardContent>
                        <MudText Typo="Typo.h6">@qr.QuestionText</MudText>
                        <MudText Typo="Typo.caption" Color="Color.Secondary">@qr.QuestionType</MudText>

                        @if (qr.OptionCounts.Any())
                        {
                            <MudTable Items="@qr.OptionCounts" Dense="true" Class="mt-2" Breakpoint="Breakpoint.Sm" Elevation="0">
                                <HeaderContent>
                                    <MudTh>Option</MudTh>
                                    <MudTh>Count</MudTh>
                                    <MudTh>Percentage</MudTh>
                                </HeaderContent>
                                <RowTemplate>
                                    <MudTd DataLabel="Option">@context.Key</MudTd>
                                    <MudTd DataLabel="Count">@context.Value</MudTd>
                                    <MudTd DataLabel="Percentage">@(qr.OptionPercentages.GetValueOrDefault(context.Key, 0).ToString("F1"))%</MudTd>
                                </RowTemplate>
                            </MudTable>
                        }

                        @if (qr.AverageRating.HasValue)
                        {
                            <MudText Class="mt-2">Average Rating: @qr.AverageRating.Value.ToString("F1") / 5</MudText>
                        }

                        @if (qr.FreeTextAnswers.Any())
                        {
                            <MudText Typo="Typo.subtitle2" Class="mt-2">Free Text Responses (shuffled):</MudText>
                            <MudList T="string" Dense="true">
                                @foreach (var answer in qr.FreeTextAnswers)
                                {
                                    <MudListItem T="string">@answer</MudListItem>
                                }
                            </MudList>
                        }
                    </MudCardContent>
                </MudCard>
            }
        }
        </div>
    }
</MudContainer>

@code {
    [Parameter] public Guid SurveyId { get; set; }

    private SurveyDto? _survey;
    private SurveyLinkResponse? _publishResult;
    private AggregateResultDto? _results;
    private string? _resultsError;
    private bool _loading = true;
    private bool _showTokens;
    private int _renderKey;

    protected override async Task OnInitializedAsync()
    {
        _survey = await Api.GetSurveyAsync(SurveyId);
        _loading = false;
    }

    private Color GetStatusColor(string status) => status switch
    {
        "Draft" => Color.Default,
        "Active" => Color.Success,
        "Closed" => Color.Error,
        _ => Color.Default
    };

    private async Task Publish()
    {
        _publishResult = await Api.PublishSurveyAsync(SurveyId);
        _survey = await Api.GetSurveyAsync(SurveyId);
        _renderKey++;
    }

    private string GetTokenLink(string token)
    {
        var baseUri = Nav.BaseUri.TrimEnd('/');
        return $"{baseUri}/survey/{_survey!.Id}?t={Uri.EscapeDataString(token)}";
    }

    private async Task CopyToClipboard(string text)
    {
        await JS.InvokeVoidAsync("navigator.clipboard.writeText", text);
    }

    private async Task CopyAllLinks()
    {
        if (_publishResult == null) return;
        var allLinks = string.Join(Environment.NewLine,
            _publishResult.Tokens.Select(t => GetTokenLink(t)));
        await CopyToClipboard(allLinks);
    }

    private async Task LoadResults()
    {
        _resultsError = null;
        var error = await Api.GetResultsErrorAsync(SurveyId);
        if (error != null)
        {
            _resultsError = error;
            return;
        }
        _results = await Api.GetResultsAsync(SurveyId);
    }
}
