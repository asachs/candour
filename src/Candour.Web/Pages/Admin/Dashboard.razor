@page "/admin"
@attribute [Authorize]
@inject ICandourApiClient Api
@inject NavigationManager Nav

<PageTitle>Admin Dashboard - Candour</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-8">
    <MudText Typo="Typo.h4" GutterBottom="true">Survey Dashboard</MudText>

    <MudButton Variant="Variant.Filled" Color="Color.Primary" Href="/admin/builder" Class="mb-4">
        Create New Survey
    </MudButton>

    @if (_loading)
    {
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
    }
    else if (_surveys.Count == 0)
    {
        <MudAlert Severity="Severity.Info">No surveys yet. Create your first one!</MudAlert>
    }
    else
    {
        <MudTable Items="@_surveys" Hover="true" Elevation="2" Breakpoint="Breakpoint.Sm">
            <HeaderContent>
                <MudTh>Title</MudTh>
                <MudTh>Status</MudTh>
                <MudTh>Threshold</MudTh>
                <MudTh>Created</MudTh>
                <MudTh>Actions</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Title">@context.Title</MudTd>
                <MudTd DataLabel="Status">
                    <MudChip T="string" Color="@GetStatusColor(context.Status)">@context.Status</MudChip>
                </MudTd>
                <MudTd DataLabel="Threshold">@context.AnonymityThreshold</MudTd>
                <MudTd DataLabel="Created">@context.CreatedAt.ToString("yyyy-MM-dd")</MudTd>
                <MudTd DataLabel="Actions" Style="text-align:right">
                    <MudButton Size="Size.Small" Variant="Variant.Outlined" Color="Color.Primary"
                               Href="@($"/admin/survey/{context.Id}")" StartIcon="@Icons.Material.Filled.Visibility">View</MudButton>
                    @if (context.Status == "Draft")
                    {
                        <MudButton Size="Size.Small" Variant="Variant.Outlined" Color="Color.Success" Class="ml-2"
                                   OnClick="@(() => PublishSurvey(context.Id))">Publish</MudButton>
                    }
                </MudTd>
            </RowTemplate>
        </MudTable>
    }
</MudContainer>

@code {
    private List<SurveyDto> _surveys = new();
    private bool _loading = true;

    protected override async Task OnInitializedAsync()
    {
        _surveys = await Api.ListSurveysAsync();
        _loading = false;
    }

    private Color GetStatusColor(string status) => status switch
    {
        "Draft" => Color.Default,
        "Active" => Color.Success,
        "Closed" => Color.Error,
        _ => Color.Default
    };

    private async Task PublishSurvey(Guid surveyId)
    {
        await Api.PublishSurveyAsync(surveyId);
        _surveys = await Api.ListSurveysAsync();
    }
}
